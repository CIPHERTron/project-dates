<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: datasources/users.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: datasources/users.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @format */

const Users = require('../models/user.js');
const Clubs = require('../models/club.js');
const AccessLevel = require('../models/accessLevel.js');
const { DataSource } = require('apollo-datasource');

class UserAPI extends DataSource {
	constructor() {
		super();
	}

	initialize(config) {}
	async getUsers(args) {
		return await Users.find(args);
	}
	async getUserById(id) {
		return await Users.findById(id);
	}
	async getUserByUsername(username) {
		return await Users.findOne({ username: username });
	}

	async addUser(user) {
		let retPromise = {};
		// Create user with basic types;
		let createdUser = await Users.create({
			username: user.username,
			name: user.name,
			gmailAuthMail: user.gmailAuthMail,
			instituteId: user.instituteId,
			address: user.address,
			mobile: user.mobile,
			emergencyContact: user.emergencyContact,
			displayPicture: user.displayPicture,
		});

		//Add nested types
		const userId = createdUser._id;
		const accessArray = user.clubAccess;
		if (accessArray != undefined &amp;&amp; accessArray.length > 0) {
			await Promise.all(
				accessArray.map(async (accessItem, index) => {
					const clubId = accessItem.club;
					const foundClub = await Clubs.findById(clubId);
					const accessObj = {
						level: accessItem.level,
						club: foundClub._id,
						user: userId,
					};
					let createdAccessLevel = await AccessLevel.create(accessObj);
					createdUser.clubAccess.push(createdAccessLevel);
					foundClub.memberAccess.push(createdAccessLevel);
					await foundClub.save();
				})
			);
		}
		retPromise = await createdUser.save();
		return retPromise;
	}

	async updateUser(args) {
		const userId = args.id;
		const user = args.user;
		let retPromise = {};
		// Create user with basic types;
		const foundUser = await Users.findById(userId);
		const originalMemberAccess = foundUser.clubAccess.slice(0);

		let updatedUser = new Users(foundUser);
		updatedUser = Object.assign(updatedUser, user);
		updatedUser = new Users(updatedUser);
		//Add nested types
		const accessArray = user.clubAccess;
		if (accessArray != undefined &amp;&amp; accessArray.length > 0) {
			// accessArray exists and is not empty
			await Promise.all(
				accessArray.map(async (accessItem, index) => {
					const clubId = accessItem.club;
					const foundClub = await Clubs.findById(clubId);
					const accessObj = {
						level: accessItem.level,
						club: foundClub._id,
						user: userId,
					};
					let createdAccessLevel = await AccessLevel.create(accessObj);
					updatedUser.clubAccess.push(createdAccessLevel._id);
					foundClub.memberAccess.push(createdAccessLevel._id);
					await foundClub.save();
				})
			);
		}

		retPromise = await updatedUser.save();
		return retPromise;
	}

	async deleteUser(id) {
		const foundUser = await Users.findById(id);
		return await foundUser.remove();
	}
}
module.exports = UserAPI;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Seed%2520Database.html">Seed Database</a></li></ul><h3>Global</h3><ul><li><a href="global.html#accessLevel">accessLevel</a></li><li><a href="global.html#buildNav">buildNav</a></li><li><a href="global.html#Clubs">Clubs</a></li><li><a href="global.html#context">context</a></li><li><a href="global.html#ERRORS">ERRORS</a></li><li><a href="global.html#Events">Events</a></li><li><a href="global.html#mongoose">mongoose</a></li><li><a href="global.html#PERMISSION_DENIED">PERMISSION_DENIED</a></li><li><a href="global.html#publish">publish</a></li><li><a href="global.html#queries">queries</a></li><li><a href="global.html#Query">Query</a></li><li><a href="global.html#types">types</a></li><li><a href="global.html#User">User</a></li><li><a href="global.html#Users">Users</a></li><li><a href="global.html#Venues">Venues</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Fri Dec 11 2020 06:49:39 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
